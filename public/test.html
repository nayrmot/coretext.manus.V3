<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Case Selection Functionality Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="container mt-5">
    <div class="row">
      <div class="col-12">
        <h1>Case Selection Functionality Test</h1>
        <p>This page tests the MongoDB integration and case selection functionality.</p>
        
        <div id="alertContainer"></div>
        
        <!-- Database Connection Test -->
        <div class="card mb-4">
          <div class="card-header">
            <h5>Database Connection Test</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <p>Test your MongoDB connection:</p>
              <button id="testDbConnection" class="btn btn-primary">Test Connection</button>
            </div>
            <div id="connectionResult" class="mt-3">
              <div class="alert alert-info">Click the button above to test your MongoDB connection.</div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h5>Global Case Selector Test</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="globalCaseSelector" class="form-label">Select Case</label>
              <select id="globalCaseSelector" class="form-select">
                <option value="all">All Cases</option>
                <!-- Cases will be loaded here -->
              </select>
            </div>
            <h2 data-base-title="Cases">Cases</h2>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h5>Cases List Test</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="casesList">
                <thead>
                  <tr>
                    <th scope="col" style="width: 40px;">
                      <input type="checkbox" class="form-check-input" id="selectAll">
                    </th>
                    <th scope="col">Case Name</th>
                    <th scope="col">Case Number</th>
                    <th scope="col">Type</th>
                    <th scope="col">Status</th>
                    <th scope="col">Documents</th>
                    <th scope="col">Created</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Cases will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h5>Case Filters Test</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter">
                  <option value="">All Statuses</option>
                  <option value="active">Active</option>
                  <option value="closed">Closed</option>
                  <option value="archived">Archived</option>
                </select>
              </div>
              <div class="col-md-3 mb-3">
                <label for="typeFilter" class="form-label">Case Type</label>
                <select class="form-select" id="typeFilter">
                  <option value="">All Types</option>
                  <option value="personal_injury">Personal Injury</option>
                  <option value="medical_malpractice">Medical Malpractice</option>
                  <option value="contract">Contract</option>
                  <option value="employment">Employment</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label for="searchInput" class="form-label">Search</label>
                <input type="text" class="form-control" id="searchInput" placeholder="Search cases...">
              </div>
              <div class="col-md-2 mb-3 d-flex align-items-end">
                <button id="applyFilters" class="btn btn-primary w-100">Apply Filters</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h5>Test Results</h5>
          </div>
          <div class="card-body">
            <pre id="testResults" class="bg-light p-3" style="max-height: 300px; overflow-y: auto;"></pre>
            <button id="runTests" class="btn btn-primary">Run Tests</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Show alert message
    function showAlert(type, message) {
      const alertContainer = document.getElementById('alertContainer');
      if (!alertContainer) return;
      
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
      alertDiv.role = 'alert';
      
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      alertContainer.appendChild(alertDiv);
      
      // Auto-dismiss after 5 seconds
      setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => {
          alertContainer.removeChild(alertDiv);
        }, 150);
      }, 5000);
    }

    // Database connection test
    document.getElementById('testDbConnection').addEventListener('click', function() {
      const connectionResult = document.getElementById('connectionResult');
      connectionResult.innerHTML = '<div class="alert alert-info">Testing connection to MongoDB...</div>';
      
      // Test the connection by making a request to a new API endpoint
      fetch('/api/test-connection')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            connectionResult.innerHTML = `
              <div class="alert alert-success">
                <strong>Connection successful!</strong><br>
                Connected to: ${data.database}<br>
                Server: ${data.server}<br>
                Version: ${data.version}
              </div>
            `;
          } else {
            connectionResult.innerHTML = `
              <div class="alert alert-warning">
                <strong>Connection established but with issues:</strong><br>
                ${data.message}
              </div>
            `;
          }
        })
        .catch(error => {
          connectionResult.innerHTML = `
            <div class="alert alert-danger">
              <strong>Connection failed!</strong><br>
              Error: ${error.message}<br><br>
              Possible causes:
              <ul>
                <li>MongoDB server is not running</li>
                <li>Connection string in .env file is incorrect</li>
                <li>Network issues preventing connection</li>
                <li>API endpoint not implemented (see server logs)</li>
              </ul>
            </div>
          `;
        });
    });

    // Load cases for the selector and table when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Load cases for the selector
      loadCasesForSelector();
      
      // Load cases for the table
      loadCasesTable();
      
      // Set up event listeners
      document.getElementById('globalCaseSelector').addEventListener('change', function() {
        const selectedCaseId = this.value;
        
        // Store the selected case ID in localStorage
        if (selectedCaseId === 'all') {
          localStorage.removeItem('selectedCaseId');
        } else {
          localStorage.setItem('selectedCaseId', selectedCaseId);
        }
        
        // Update UI based on selected case
        updatePageTitle(selectedCaseId);
      });
      
      document.getElementById('applyFilters').addEventListener('click', function() {
        loadCasesTable();
      });
      
      document.getElementById('runTests').addEventListener('click', function() {
        runTests();
      });
    });

    // Load cases for the selector
    function loadCasesForSelector() {
      const selector = document.getElementById('globalCaseSelector');
      
      // Fetch cases from the public API endpoint
      fetch('/api/public-cases')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch cases');
          }
          return response.json();
        })
        .then(data => {
          if (data.success && data.data && data.data.length > 0) {
            // Clear existing options except "All Cases"
            while (selector.options.length > 1) {
              selector.remove(1);
            }
            
            // Add cases to the selector
            data.data.forEach(caseItem => {
              const option = document.createElement('option');
              option.value = caseItem._id;
              option.textContent = caseItem.name;
              selector.appendChild(option);
            });
            
            // Set the selected case from localStorage if available
            const selectedCaseId = localStorage.getItem('selectedCaseId');
            if (selectedCaseId) {
              selector.value = selectedCaseId;
            }
            
            showAlert('success', 'Cases loaded successfully for selector');
          } else {
            showAlert('warning', 'No cases found in database');
          }
        })
        .catch(error => {
          console.error('Error loading cases for selector:', error);
          showAlert('error', 'Failed to load cases for selector: ' + error.message);
        });
    }

    // Load cases for the table
    function loadCasesTable() {
      const casesTableBody = document.querySelector('#casesList tbody');
      
      // Clear existing rows
      casesTableBody.innerHTML = '';
      
      // Show loading indicator
      casesTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Loading cases...</td></tr>';
      
      // Get filter values
      const statusFilter = document.getElementById('statusFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const searchFilter = document.getElementById('searchInput').value;
      
      // Build query string
      let queryParams = new URLSearchParams();
      if (statusFilter) queryParams.append('status', statusFilter);
      if (typeFilter) queryParams.append('type', typeFilter);
      if (searchFilter) queryParams.append('search', searchFilter);
      
      // Get selected case ID
      const selectedCaseId = localStorage.getItem('selectedCaseId');
      if (selectedCaseId && selectedCaseId !== 'all') {
        queryParams.append('caseId', selectedCaseId);
      }
      
      // Build API URL
      let apiUrl = '/api/public-cases';
      if (queryParams.toString()) {
        apiUrl += '?' + queryParams.toString();
      }
      
      // Fetch cases from the API
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch cases');
          }
          return response.json();
        })
        .then(data => {
          // Clear loading indicator
          casesTableBody.innerHTML = '';
          
          if (data.success && data.data && data.data.length > 0) {
            // Add cases to the table
            data.data.forEach(caseItem => {
              const row = createCaseRow(caseItem);
              casesTableBody.appendChild(row);
            });
            
            showAlert('success', `Loaded ${data.data.length} cases successfully`);
          } else {
            // No cases found - show a more friendly message
            casesTableBody.innerHTML = '<tr><td colspan="8" class="text-center">No cases found. Create a new case to get started.</td></tr>';
            showAlert('warning', 'No cases found matching your criteria');
          }
        })
        .catch(error => {
          console.error('Error loading cases:', error);
          casesTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load cases. Please try again later.</td></tr>';
          showAlert('error', 'Failed to load cases: ' + error.message);
        });
    }

    // Create a table row for a case
    function createCaseRow(caseItem) {
      const row = document.createElement('tr');
      
      // Checkbox cell
      const checkboxCell = document.createElement('td');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'form-check-input case-checkbox';
      checkbox.dataset.caseId = caseItem._id;
      checkboxCell.appendChild(checkbox);
      row.appendChild(checkboxCell);
      
      // Case name cell
      const nameCell = document.createElement('td');
      const nameLink = document.createElement('a');
      nameLink.href = `#case-${caseItem._id}`;
      nameLink.textContent = caseItem.name;
      nameCell.appendChild(nameLink);
      row.appendChild(nameCell);
      
      // Case number cell
      const numberCell = document.createElement('td');
      numberCell.textContent = caseItem.caseNumber;
      row.appendChild(numberCell);
      
      // Type cell
      const typeCell = document.createElement('td');
      typeCell.textContent = caseItem.type || 'N/A';
      row.appendChild(typeCell);
      
      // Status cell
      const statusCell = document.createElement('td');
      const statusBadge = document.createElement('span');
      statusBadge.className = `badge bg-${getStatusColor(caseItem.status)}`;
      statusBadge.textContent = caseItem.status;
      statusCell.appendChild(statusBadge);
      row.appendChild(statusCell);
      
      // Documents cell
      const docsCell = document.createElement('td');
      docsCell.textContent = caseItem.documentCount || '0';
      row.appendChild(docsCell);
      
      // Created date cell
      const createdCell = document.createElement('td');
      createdCell.textContent = new Date(caseItem.createdAt).toLocaleDateString();
      row.appendChild(createdCell);
      
      // Actions cell
      const actionsCell = document.createElement('td');
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'dropdown';
      
      const actionsButton = document.createElement('button');
      actionsButton.className = 'btn btn-sm btn-outline-secondary dropdown-toggle';
      actionsButton.type = 'button';
      actionsButton.dataset.bsToggle = 'dropdown';
      actionsButton.innerHTML = '<i class="bi bi-three-dots"></i>';
      
      const actionsMenu = document.createElement('ul');
      actionsMenu.className = 'dropdown-menu';
      
      const viewAction = createActionItem('View', `#view-${caseItem._id}`, 'bi-eye');
      const editAction = createActionItem('Edit', `#edit-${caseItem._id}`, 'bi-pencil');
      const deleteAction = createActionItem('Delete', '#', 'bi-trash');
      deleteAction.addEventListener('click', function(e) {
        e.preventDefault();
        showAlert('info', `Delete action clicked for case: ${caseItem.name}`);
      });
      
      actionsMenu.appendChild(viewAction);
      actionsMenu.appendChild(editAction);
      actionsMenu.appendChild(deleteAction);
      
      actionsDiv.appendChild(actionsButton);
      actionsDiv.appendChild(actionsMenu);
      actionsCell.appendChild(actionsDiv);
      row.appendChild(actionsCell);
      
      return row;
    }

    // Create an action item for the dropdown menu
    function createActionItem(text, href, iconClass) {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.className = 'dropdown-item';
      a.href = href;
      
      const icon = document.createElement('i');
      icon.className = `bi ${iconClass} me-2`;
      
      a.appendChild(icon);
      a.appendChild(document.createTextNode(text));
      li.appendChild(a);
      
      return li;
    }

    // Get color for status badge
    function getStatusColor(status) {
      switch (status?.toLowerCase()) {
        case 'active':
          return 'success';
        case 'pending':
          return 'warning';
        case 'closed':
          return 'secondary';
        case 'archived':
          return 'info';
        default:
          return 'primary';
      }
    }

    // Update page title based on selected case
    function updatePageTitle(caseId) {
      const pageTitleElement = document.querySelector('[data-base-title]');
      if (!pageTitleElement) return;
      
      const baseTitle = pageTitleElement.getAttribute('data-base-title');
      
      if (caseId === 'all') {
        pageTitleElement.textContent = baseTitle;
      } else {
        // Find the case name from the selector
        const selector = document.getElementById('globalCaseSelector');
        const selectedOption = selector.options[selector.selectedIndex];
        if (selectedOption) {
          pageTitleElement.textContent = `${baseTitle} - ${selectedOption.textContent}`;
        }
      }
    }

    // Run tests
    function runTests() {
      const testResults = document.getElementById('testResults');
      testResults.innerHTML = '';
      
      console.log = function(message) {
        testResults.innerHTML += message + '\n';
      };
      
      console.log('Running case selection tests...');
      console.log('-----------------------------');
      
      // Test 1: Database connection
      console.log('Test 1: Database connection');
      fetch('/api/test-connection')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('✅ Database connection successful');
          } else {
            console.log('❌ Database connection failed: ' + data.message);
          }
          
          // Test 2: Case loading
          console.log('\nTest 2: Case loading');
          return fetch('/api/public-cases');
        })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.data && data.data.length > 0) {
            console.log(`✅ Successfully loaded ${data.data.length} cases`);
          } else {
            console.log('❌ Failed to load cases or no cases found');
          }
          
          // Test 3: Case selector
          console.log('\nTest 3: Case selector');
          const selector = document.getElementById('globalCaseSelector');
          if (selector.options.length > 1) {
            console.log(`✅ Case selector populated with ${selector.options.length - 1} cases`);
          } else {
            console.log('❌ Case selector not populated');
          }
          
          // Test 4: LocalStorage
          console.log('\nTest 4: LocalStorage');
          try {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            console.log('✅ LocalStorage is working');
          } catch (e) {
            console.log('❌ LocalStorage is not available: ' + e.message);
          }
          
          console.log('\nTests completed!');
        })
        .catch(error => {
          console.log('❌ Error running tests: ' + error.message);
        });
    }
  </script>
</body>
</html>
